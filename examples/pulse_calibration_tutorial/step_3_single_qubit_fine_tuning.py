"""
========================================================================
TyxonQ è„‰å†²è°ƒæ•™å®æˆ˜æ•™ç¨‹ - ç¬¬ 3 æ­¥ï¼šå•æ¯”ç‰¹é—¨ç²¾ç»†è°ƒä¼˜ä¸ Rabi è¡¨å¾
========================================================================

æœ¬æ­¥éª¤çš„ç›®çš„æ˜¯ï¼š
âœ… ç²¾ç»†è°ƒæ•´è„‰å†²å‚æ•°ä»¥è¾¾åˆ°ç›®æ ‡æ—‹è½¬è§’
âœ… é€šè¿‡ Rabi æŒ¯è¡è¡¨å¾è„‰å†²çš„çœŸå®ç‰¹æ€§
âœ… ä¼˜åŒ–ä¿çœŸåº¦è‡³ > 99.9%

å­¦ä¹ é¢„æœŸæ—¶é—´ï¼š60 åˆ†é’Ÿ
éš¾åº¦ï¼šâ˜…â˜…â˜…â˜†â˜†

========================================================================
å®è·µï¼šç²¾ç»†è°ƒä¼˜ä¸ Rabi æµ‹é‡
========================================================================
"""

import numpy as np
from tyxonq import Circuit, waveforms
from tyxonq.core.ir.pulse import PulseProgram

print("""
â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
â•‘  TyxonQ è„‰å†²è°ƒæ•™æ•™ç¨‹ - ç¬¬ 3 æ­¥ï¼šå•æ¯”ç‰¹é—¨ç²¾ç»†è°ƒä¼˜                       â•‘
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
""")

# ========================================================================
# ç¬¬ 3.1 éƒ¨åˆ†ï¼šç²¾ç»†æŒ¯å¹…è°ƒæ•´
# ========================================================================

print("""
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
3.1 ç²¾ç»†æŒ¯å¹…è°ƒæ•´ï¼šè¾¾åˆ°ç²¾ç¡®çš„ Ï€ æ—‹è½¬
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

ä»ç¬¬ 2 æ­¥è·å¾—çš„ç²—è°ƒå‚æ•°ï¼š
  â€¢ æŒ¯å¹…ï¼šçº¦ 0.8V
  â€¢ æ—¶é•¿ï¼š160 ns
  â€¢ Î²ï¼šçº¦ 0.2

ç°åœ¨è¿›è¡Œç²¾ç»†æ‰«æï¼š
  â€¢ èŒƒå›´ï¼šÂ±10% çš„ç²—è°ƒæŒ¯å¹…
  â€¢ æ­¥é•¿ï¼š0.01 Vï¼ˆé«˜ç²¾åº¦ï¼‰
""")

# ä»ç¬¬ 2 æ­¥çš„ç²—è°ƒç»“æœ
coarse_amp = 0.8
coarse_duration = 160
coarse_beta = 0.2
coarse_sigma = coarse_duration / 4

# ç²¾ç»†æ‰«æèŒƒå›´
fine_amplitudes = np.linspace(coarse_amp - 0.1, coarse_amp + 0.1, 21)

print(f"\nğŸ”¬ ç²¾ç»†æŒ¯å¹…æ‰«æ")
print(f"   èŒƒå›´ï¼š{fine_amplitudes[0]:.3f} åˆ° {fine_amplitudes[-1]:.3f} V")
print(f"   æ­¥é•¿ï¼š{(fine_amplitudes[1] - fine_amplitudes[0]):.3f} V")
print(f"   æ‰«æç‚¹æ•°ï¼š{len(fine_amplitudes)}")

print(f"\nå¼€å§‹æ‰«æ...")
print("â”€" * 90)

fine_results = []

for amp in fine_amplitudes:
    prog = PulseProgram(num_qubits=1)
    prog.set_device_params(
        qubit_freq=[5.0e9],
        anharmonicity=[-330e6],
        T1=[80e-6],
        T2=[120e-6]
    )
    
    pulse = waveforms.Drag(
        amp=amp,
        duration=coarse_duration,
        sigma=coarse_sigma,
        beta=coarse_beta
    )
    prog.add_pulse(0, pulse, qubit_freq=5.0e9)
    state = prog.state(backend="numpy")
    
    pop_1 = abs(state[1])**2
    leakage = 1 - abs(state[0])**2 - pop_1
    
    # æ¨æ–­æ—‹è½¬è§’
    inferred_angle = 2 * np.arcsin(np.sqrt(pop_1)) if pop_1 <= 1.0 else np.nan
    angle_error = abs(inferred_angle - np.pi)
    
    # ä¿çœŸåº¦ä¼°è®¡
    fidelity = (1 - leakage) * pop_1
    
    fine_results.append({
        'amp': amp,
        'pop_1': pop_1,
        'leakage': leakage,
        'angle': inferred_angle,
        'angle_error': angle_error,
        'fidelity': fidelity
    })
    
    if amp % 0.05 < 0.01 or angle_error < 0.05:
        status = "âœ…" if fidelity > 0.99 else "âœ…" if fidelity > 0.95 else "âš ï¸"
        print(f"{status} æŒ¯å¹… {amp:.3f}V: Pâ‚={pop_1:.5f}  Î¸={inferred_angle/np.pi:.5f}Ï€  "
              f"è¯¯å·®={angle_error:.5f}  æ³„æ¼={leakage:.5f}  ä¿çœŸåº¦={fidelity:.5f}")

# æ‰¾åˆ°æœ€ä¼˜æŒ¯å¹…
best_fine_idx = np.argmin([r['angle_error'] for r in fine_results])
best_fine = fine_results[best_fine_idx]

print("\n" + "=" * 90)
print("ğŸ¯ ç²¾ç»†è°ƒä¼˜æœ€ä½³æŒ¯å¹…ï¼š")
print("=" * 90)
print(f"   æœ€ä¼˜æŒ¯å¹…ï¼š{best_fine['amp']:.4f} V")
print(f"   æ¨æ–­æ—‹è½¬è§’ï¼š{best_fine['angle']/np.pi:.6f}Ï€ï¼ˆç›®æ ‡ 1.0000Ï€ï¼‰")
print(f"   è§’åº¦è¯¯å·®ï¼š{best_fine['angle_error']:.6f}ï¼ˆçº¦ {best_fine['angle_error']/np.pi*100:.3f}%ï¼‰")
print(f"   |1âŸ© äººå£ï¼š{best_fine['pop_1']:.6f}ï¼ˆç›®æ ‡ 1.0ï¼‰")
print(f"   æ³„æ¼ç‡ï¼š{best_fine['leakage']:.6f}ï¼ˆç›®æ ‡ < 0.1%ï¼‰")
print(f"   ä¼°è®¡ä¿çœŸåº¦ï¼š{best_fine['fidelity']:.5f}ï¼ˆ{best_fine['fidelity']*100:.3f}%ï¼‰")

# ========================================================================
# ç¬¬ 3.2 éƒ¨åˆ†ï¼šRabi æŒ¯è¡è¡¨å¾
# ========================================================================

print("""
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
3.2 Rabi æŒ¯è¡æµ‹é‡ï¼šéªŒè¯è„‰å†²ç‰¹æ€§
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

åŸç†ï¼š
  ä¿æŒè„‰å†²å¹…åº¦å›ºå®šï¼Œæ‰«æè„‰å†²æ—¶é•¿
  æµ‹é‡ |1âŸ© çš„äººå£éšæ—¶é•¿çš„å˜åŒ–
  ä»è€Œç»˜åˆ¶ Rabi æŒ¯è¡æ›²çº¿
  
ç”¨é€”ï¼š
  âœ… éªŒè¯ Rabi é¢‘ç‡æ˜¯å¦ä¸ç†è®ºä¸€è‡´
  âœ… æ£€æµ‹è„‰å†²è´¨é‡ï¼ˆå¯¹æ¯”åº¦ã€è¡°å‡ï¼‰
  âœ… ç²¾ç¡®æ ¡å‡†æ—‹è½¬è§’ï¼ˆæ‰¾åˆ°ç¬¬ä¸€ä¸ªé›¶ç‚¹ï¼‰
""")

# Rabi æ‰«æï¼šæ‰«æè„‰å†²æ—¶é•¿
rabi_durations = np.linspace(10, 400, 40)  # 10 åˆ° 400 nsï¼Œ40 ä¸ªç‚¹

print(f"\nğŸ”¬ Rabi æŒ¯è¡æ‰«æ")
print(f"   æ‰«æèŒƒå›´ï¼š{rabi_durations[0]:.0f} åˆ° {rabi_durations[-1]:.0f} ns")
print(f"   æ‰«æç‚¹æ•°ï¼š{len(rabi_durations)}")

print(f"\nå¼€å§‹ Rabi æ‰«æ...")

rabi_results = []

for duration in rabi_durations:
    prog = PulseProgram(num_qubits=1)
    prog.set_device_params(
        qubit_freq=[5.0e9],
        anharmonicity=[-330e6],
        T1=[80e-6],
        T2=[120e-6]
    )
    
    pulse = waveforms.Drag(
        amp=best_fine['amp'],
        duration=int(duration),
        sigma=int(duration / 4),
        beta=coarse_beta
    )
    prog.add_pulse(0, pulse, qubit_freq=5.0e9)
    state = prog.state(backend="numpy")
    
    pop_1 = abs(state[1])**2
    
    rabi_results.append({
        'duration': duration,
        'pop_1': pop_1
    })

# æ‰¾åˆ°å‡ ä¸ªå…³é”®ç‚¹
rabi_durations_arr = np.array([r['duration'] for r in rabi_results])
rabi_pops = np.array([r['pop_1'] for r in rabi_results])

# æ‰¾åˆ° Ï€/2ï¼ˆP_1 â‰ˆ 0.5ï¼‰å’Œ Ï€ï¼ˆP_1 â‰ˆ 1ï¼‰
idx_pi_over_2 = np.argmin(np.abs(rabi_pops - 0.5))
idx_pi = np.argmin(np.abs(rabi_pops - 1.0))

print("\nğŸ“Š Rabi æŒ¯è¡å…³é”®ç‚¹ï¼š")
print("â”€" * 60)
print(f"{'æ—‹è½¬è§’':<12} {'æ—¶é•¿(ns)':<15} {'|1âŸ©äººå£':<15} {'ç²¾åº¦è¯„ä»·':<20}")
print("â”€" * 60)

# Ï€/2 æ—‹è½¬
t_pi_2 = rabi_durations_arr[idx_pi_over_2]
p1_pi_2 = rabi_pops[idx_pi_over_2]
print(f"{'Ï€/2':<12} {t_pi_2:<15.1f} {p1_pi_2:<15.4f} {'âœ…' if abs(p1_pi_2 - 0.5) < 0.05 else 'âš ï¸'}")

# Ï€ æ—‹è½¬
t_pi = rabi_durations_arr[idx_pi]
p1_pi = rabi_pops[idx_pi]
print(f"{'Ï€':<12} {t_pi:<15.1f} {p1_pi:<15.4f} {'âœ…' if abs(p1_pi - 1.0) < 0.05 else 'âš ï¸'}")

# æå– Rabi é¢‘ç‡
rabi_frequency = np.pi / (t_pi * 1e-9)  # è½¬æ¢ä¸º rad/s
rabi_frequency_mhz = rabi_frequency / (2*np.pi) / 1e6  # è½¬æ¢ä¸º MHz

print(f"\nğŸ“ˆ Rabi é¢‘ç‡è®¡ç®—ï¼š")
print("â”€" * 60)
print(f"   ä» Ï€ æ—‹è½¬æ—¶é•¿ {t_pi:.1f} ns æ¨æ–­ï¼š")
print(f"   Î© = Ï€ / t = {rabi_frequency/(2*np.pi)/1e6:.2f} MHz")

# ========================================================================
# ç¬¬ 3.3 éƒ¨åˆ†ï¼šH é—¨è°ƒæ•™
# ========================================================================

print("""
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
3.3 H é—¨è°ƒæ•™ï¼šÏ€/âˆš2 æ—‹è½¬
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

H é—¨æ˜¯ Ï€/âˆš2 æ—‹è½¬ï¼Œåœ¨ (X+Z)/âˆš2 æ–¹å‘
ä» Rabi é¢‘ç‡å¯ä»¥æ¨å¯¼æ‰€éœ€æ—¶é•¿
""")

# è®¡ç®— H é—¨æ‰€éœ€æ—¶é•¿
h_duration_required = (np.pi / np.sqrt(2)) / rabi_frequency * 1e9

print(f"\nğŸ¯ è®¡ç®— H é—¨å‚æ•°ï¼š")
print(f"   æ‰€éœ€æ—‹è½¬è§’ï¼šÏ€/âˆš2 = {np.pi/np.sqrt(2):.4f} rad")
print(f"   æ‰€éœ€æ—¶é•¿ï¼š{h_duration_required:.1f} ns")

# éªŒè¯ H é—¨
prog_h = PulseProgram(num_qubits=1)
prog_h.set_device_params(
    qubit_freq=[5.0e9],
    anharmonicity=[-330e6],
    T1=[80e-6],
    T2=[120e-6]
)

pulse_h = waveforms.Drag(
    amp=best_fine['amp'],
    duration=int(h_duration_required),
    sigma=int(h_duration_required / 4),
    beta=coarse_beta
)
prog_h.add_pulse(0, pulse_h, qubit_freq=5.0e9)
state_h = prog_h.state(backend="numpy")

pop_0_h = abs(state_h[0])**2
pop_1_h = abs(state_h[1])**2
leakage_h = 1 - pop_0_h - pop_1_h

h_fidelity = 1 - abs(pop_0_h - 0.5) - abs(pop_1_h - 0.5) - leakage_h

print(f"\nâœ… H é—¨éªŒè¯ç»“æœï¼š")
print(f"   |0âŸ© äººå£ï¼š{pop_0_h:.5f}ï¼ˆç†æƒ³ 0.5ï¼‰")
print(f"   |1âŸ© äººå£ï¼š{pop_1_h:.5f}ï¼ˆç†æƒ³ 0.5ï¼‰")
print(f"   æ³„æ¼ç‡ï¼š{leakage_h:.5f}")
print(f"   ä¿çœŸåº¦ï¼ˆä¼°è®¡ï¼‰ï¼š{h_fidelity:.5f}ï¼ˆ{h_fidelity*100:.3f}%ï¼‰")

# ========================================================================
# æ€»ç»“
# ========================================================================

print("""
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
ğŸ“Œ ç¬¬ 3 æ­¥æ€»ç»“ä¸è°ƒæ•™ç»“æœ
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
""")

print(f"""
âœ… å®Œæˆçš„å•æ¯”ç‰¹é—¨è°ƒæ•™ï¼š

1ï¸âƒ£ X é—¨ï¼ˆÏ€ æ—‹è½¬ï¼‰
   â€¢ æŒ¯å¹…ï¼š{best_fine['amp']:.4f} V
   â€¢ æ—¶é•¿ï¼š{coarse_duration} ns
   â€¢ Ïƒï¼š{coarse_sigma} ns
   â€¢ Î²ï¼š{coarse_beta:.2f}
   â€¢ ä¿çœŸåº¦ï¼š{best_fine['fidelity']:.5f}ï¼ˆ{best_fine['fidelity']*100:.3f}%ï¼‰

2ï¸âƒ£ H é—¨ï¼ˆÏ€/âˆš2 æ—‹è½¬ï¼‰
   â€¢ æŒ¯å¹…ï¼š{best_fine['amp']:.4f} V
   â€¢ æ—¶é•¿ï¼š{h_duration_required:.1f} ns
   â€¢ Ïƒï¼š{h_duration_required/4:.1f} ns
   â€¢ Î²ï¼š{coarse_beta:.2f}
   â€¢ ä¿çœŸåº¦ï¼š{h_fidelity:.5f}ï¼ˆ{h_fidelity*100:.3f}%ï¼‰

3ï¸âƒ£ Rabi ç‰¹æ€§è¡¨å¾
   â€¢ æå–çš„ Rabi é¢‘ç‡ï¼š{rabi_frequency_mhz:.2f} MHz

âš ï¸ å½“å‰çŠ¶æ€ï¼š
   âœ… å•æ¯”ç‰¹é—¨å·²ä¼˜åŒ–åˆ°è¾ƒé«˜ä¿çœŸåº¦
   âœ… Rabi æŒ¯è¡å·²å……åˆ†è¡¨å¾
   âš ï¸ è¿˜éœ€è¦è¿›è¡Œæ ‡å‡†çš„é—¨ä¿çœŸåº¦æµ‹è¯•
   âš ï¸ è¿˜éœ€è¦æ ¹æ®å®éªŒè°ƒæ•´å‚æ•°

ğŸ¯ ä¸‹ä¸€æ­¥ï¼ˆç¬¬ 4 æ­¥ï¼‰ï¼š
   â†’ è¿›è¡ŒåŒæ¯”ç‰¹é—¨ï¼ˆCXï¼‰çš„è°ƒæ•™
   â†’ ä¼˜åŒ– CR è„‰å†²å‚æ•°
   â†’ åˆ¶å¤‡ Bell æ€è¿›è¡Œä¿çœŸåº¦æµ‹è¯•

â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
""")

print("\nâœ¨ ç¬¬ 3 æ­¥å®Œæˆï¼å•æ¯”ç‰¹é—¨è°ƒæ•™å·²åˆæ­¥å®Œæˆ...")
