"""
========================================================================
TyxonQ 脉冲调教实战教程 - 第 1 步：硬件基础与环境配置
========================================================================

本步骤是整个调教流程的基础，目的是：
✅ 理解量子硬件的基本参数
✅ 建立脉冲编程框架的认知
✅ 为后续调教工作做准备

学习预期时间：30 分钟
难度：★☆☆☆☆

========================================================================
核心概念介绍
========================================================================

1. 超导量子比特的三能级模型
   ────────────────────────────
   
   能级图：
   
                |2⟩ ──────────────  能量: ℏω₀ + ℏω_q + ℏα
                     ↑ ↓
                     transition
                     frequency = α
                     (通常是负数！)
                     
                |1⟩ ──────────────  能量: ℏω₀ + ℏω_q
                     ↑ ↓
                     transition
                     frequency = ω_q
                     (通常 5-6 GHz)
                     
                |0⟩ ──────────────  能量: ℏω₀ (基态)
   
   物理含义：
   • |0⟩：基态（最低能量）- 我们计算用这个
   • |1⟩：第一激发态 - 我们计算用这个
   • |2⟩：第二激发态 - 泄漏（leakage）的地方！
   
   为什么 α 是负数？
   → 这是超导约瑟夫森结的特性
   → 负的非谐性提供了能量保护
   → 防止系统不断激发到更高能级

2. 关键硬件参数
   ──────────────
   
   • ω_q (qubit_freq): 量子比特的驾驶频率
     单位: Hz (通常在 4-6 GHz)
     来源: 通过微波频率扫描（spectrum scan）测得
     用途: 定义脉冲的中心频率
     
   • α (anharmonicity): 非谐性（第一和第二能级差）
     单位: Hz (通常是负的，-100 到 -500 MHz)
     含义: α = (E_2 - E_1) - (E_1 - E_0)
     用途: 定义脉冲作用范围，防止泄漏
     
   • T1: 能量驰豫时间
     单位: 秒 (通常 50-150 微秒 μs)
     含义: 激发态 |1⟩ 衰减回基态 |0⟩ 的时间常数
     公式: P_1(t) = exp(-t / T1)
     用途: 决定了有效的计算时间窗口
     
   • T2: 相位驰豫时间（通常称 T2*）
     单位: 秒 (通常 50-200 微秒 μs)
     含义: 相位信息衰减的时间常数
     公式: 相位 φ(t) = φ_0 · exp(-t / T2*)
     用途: 限制多量子比特门的持续时间
     
   • 物理门时间限制
     单轨道比特门: 10-100 ns
     两比特门: 50-500 ns
     关键：必须 << T1, T2

3. 脉冲的物理本质
   ──────────────
   
   驾驶脉冲（Driving Pulse）:
   
   时域表示：
     I(t) = A(t) cos(ω_d t + φ)  # 同相分量 (In-phase)
     Q(t) = A(t) sin(ω_d t + φ)  # 正交分量 (Quadrature)
   
   其中：
   • A(t): 包络函数（envelope）- 通常是 Gaussian 或 DRAG
   • ω_d: 驾驶频率 - 通常就是 ω_q
   • φ: 初始相位 - 可以调整
   
   为什么需要包络 A(t)？
   → 防止脉冲边缘的尖锐跳变
   → 减少谱旁瓣（spectral sidebands）
   → 降低泄漏到 |2⟩ 的概率
   
   包络类型：
   
   a) Constant (矩形脉冲):
      A(t) = A0 (在脉冲持续时间内)
      优点：简单，清晰
      缺点：高频谐波多，泄漏大
      
   b) Gaussian (高斯包络):
      A(t) = A0 · exp(-t² / (2σ²))
      优点：光滑，低频谐波
      缺点：边缘衰减，需要补偿
      
   c) DRAG (导数去除绝热门):
      I(t) = A0 · exp(-t² / (2σ²))
      Q(t) = β · dA/dt    # 关键：导数项！
      优点：显著抑制泄漏到 |2⟩
      缺点：参数多，需要 β 优化

4. TyxonQ 框架快速入门
   ─────────────────────
   
   两种编程模式：
   
   a) 门电路模式（Gate Circuit）- Mode A
      ──────────────────────────
      circuit = Circuit(2)        # 2 个量子比特
      circuit.h(0)                # Hadamard 门在 q0
      circuit.cx(0, 1)            # CX 门，q0 控制，q1 目标
      circuit.measure_z(0)        # 测量基态
      
      优点：高级，易用
      缺点：无法精细控制脉冲参数
      
   b) 脉冲模式（Pure Pulse）- Mode B
      ────────────────────
      prog = PulseProgram(2)      # 2 个量子比特
      prog.drag(0, amp=0.8, duration=160, sigma=40, beta=0.2)
      prog.gaussian(1, amp=0.5, duration=200, sigma=50)
      
      优点：完全控制脉冲，调教必备
      缺点：低级，需要理解脉冲细节

========================================================================
实践部分：获取硬件参数
========================================================================
"""

import numpy as np
from tyxonq import Circuit, waveforms
from tyxonq.core.ir.pulse import PulseProgram

print("""
╔════════════════════════════════════════════════════════════════════════╗
║  TyxonQ 脉冲调教教程 - 第 1 步：硬件基础与环境配置                     ║
╚════════════════════════════════════════════════════════════════════════╝
""")

# ========================================================================
# 部分 1.1: 定义典型的超导量子比特硬件参数
# ========================================================================

print("""
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
1.1 定义硬件参数（从实验中获取的典型值）
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
""")

# 典型的超导量子比特参数（基于 Homebrew S2 平台）
hardware_config = {
    # 频率参数
    "qubit_freq": [
        5.0e9,      # q0: 5.000 GHz
        5.1e9,      # q1: 5.100 GHz
        5.2e9,      # q2: 5.200 GHz
    ],
    
    # 非谐性（负值表示频率随能级增加而减小）
    "anharmonicity": [
        -330e6,     # q0: -330 MHz
        -320e6,     # q1: -320 MHz  
        -340e6,     # q2: -340 MHz
    ],
    
    # 驰豫时间（能量损失）
    "T1": [
        80e-6,      # q0: 80 μs
        85e-6,      # q1: 85 μs
        75e-6,      # q2: 75 μs
    ],
    
    # 相干时间（相位噪声）
    "T2": [
        120e-6,     # q0: 120 μs
        125e-6,     # q1: 125 μs
        110e-6,     # q2: 110 μs
    ],
}

print("✅ 超导量子比特硬件参数（3 比特系统）")
print(f"\n比特    频率(GHz)    非谐性(MHz)    T1(μs)    T2(μs)")
print("─" * 60)

for i in range(3):
    freq = hardware_config["qubit_freq"][i] / 1e9
    anharmonicity = hardware_config["anharmonicity"][i] / 1e6
    t1 = hardware_config["T1"][i] * 1e6
    t2 = hardware_config["T2"][i] * 1e6
    print(f"q{i}     {freq:.3f}        {anharmonicity:>6.0f}         {t1:.0f}      {t2:.0f}")

# ========================================================================
# 部分 1.2: 量子比特操作时间的理论基础
# ========================================================================

print("""
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
1.2 门操作的时间分析
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
""")

print("\n🎯 核心原理：Rabi 旋转")
print("─" * 60)

print("""
在驾驶场作用下，量子比特的状态会在 |0⟩ 和 |1⟩ 之间振荡。
这种振荡称为 Rabi 振荡。

Rabi 频率（旋转速度）：
  Ω = γ · A
  
  其中：
  • γ: 旋转偶合常数（约 2π × 数十 MHz/V）
  • A: 脉冲振幅

旋转角（旋转了多少）：
  θ = Ω · t = γ · A · t
  
  其中：
  • t: 脉冲持续时间

常见脉冲：
  • π 脉冲（π 旋转）:  θ = π  → 将 |0⟩ 变为 |1⟩
  • π/2 脉冲:          θ = π/2 → 创建叠加态
  • π/4 脉冲:          θ = π/4 → 部分旋转
""")

# 计算典型门时间
gamma = 2 * np.pi * 50e6  # 旋转偶合常数（约 50 MHz/V）

print("\n📊 计算典型门执行时间")
print("─" * 60)

pulse_params = {
    "X gate": {"amp": 0.8, "desired_angle": np.pi},
    "H gate": {"amp": 0.8, "desired_angle": np.pi / np.sqrt(2)},
    "π/2 pulse": {"amp": 0.4, "desired_angle": np.pi / 2},
}

print(f"\n假设 γ = {gamma / (2*np.pi) / 1e6:.0f} MHz/V\n")
print("门类型          振幅    目标旋转角    估计时长(ns)    备注")
print("─" * 80)

for gate_name, params in pulse_params.items():
    amp = params["amp"]
    angle = params["desired_angle"]
    rabi_freq = gamma * amp
    time_needed = angle / rabi_freq * 1e9  # 转换为纳秒
    
    print(f"{gate_name:<15} {amp:.2f}    {angle/np.pi:.2f}π        {time_needed:>6.0f}         ", end="")
    
    if time_needed < 50:
        print("太短，受限制")
    elif time_needed < 100:
        print("快速门")
    else:
        print("标准门时间")

# ========================================================================
# 部分 1.3: 脉冲类型的直观对比
# ========================================================================

print("""
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
1.3 脉冲类型的对比与选择
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
""")

waveform_comparison = {
    "Constant": {
        "definition": "A(t) = A₀ (矩形)",
        "leakage": "高 (5-10%)",
        "execution_time": "快",
        "complexity": "简单",
        "use_case": "初期快速测试",
    },
    "Gaussian": {
        "definition": "A(t) = A₀ exp(-t²/2σ²)",
        "leakage": "中 (1-3%)",
        "execution_time": "中等",
        "complexity": "中等",
        "use_case": "标准生产使用",
    },
    "DRAG": {
        "definition": "I(t) = A₀ exp(-t²/2σ²) + Q(t) = β·dA/dt",
        "leakage": "低 (<1%)",
        "execution_time": "中等",
        "complexity": "复杂（需要 β 优化）",
        "use_case": "高保真生产",
    },
}

print("\n脉冲类型对比表：")
print("─" * 100)
print(f"{'类型':<12} {'定义':<40} {'泄漏':<12} {'速度':<8} {'复杂度':<8} {'应用':<20}")
print("─" * 100)

for wtype, props in waveform_comparison.items():
    print(f"{wtype:<12} {props['definition']:<40} {props['leakage']:<12} ", end="")
    print(f"{props['execution_time']:<8} {props['complexity']:<8} {props['use_case']:<20}")

print("\n💡 选择建议：")
print("   阶段 1（初探）: 使用 Constant，快速验证概念")
print("   阶段 2（优化）: 切换到 Gaussian，平衡速度和保真度")
print("   阶段 3（生产）: 使用 DRAG，最大化保真度")

# ========================================================================
# 部分 1.4: 用 TyxonQ 创建第一个脉冲程序
# ========================================================================

print("""
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
1.4 第一个脉冲程序：简单的 X 门
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
""")

print("\n📝 代码演示：创建一个简单的 X 门脉冲")
print("─" * 60)

# 创建一个单比特脉冲程序
prog = PulseProgram(num_qubits=1)

# 设置硬件参数
# 这些参数会被模拟器用来计算量子动力学
prog.set_device_params(
    qubit_freq=[5.0e9],              # q0 的驾驶频率：5.0 GHz
    anharmonicity=[-330e6],           # 非谐性：-330 MHz
    T1=[80e-6],                       # T1：80 μs
    T2=[120e-6]                       # T2：120 μs
)

# 添加脉冲：Gaussian 包络的 π 旋转（X 门）
x_pulse = waveforms.Gaussian(
    amp=0.8,            # 振幅：0.8 V（需要在后续调教中精细化）
    duration=160,       # 脉冲时长：160 ns
    sigma=40            # 高斯宽度：40 ns（推荐 = duration/4）
)

prog.add_pulse(
    qubit=0,            # 加到 q0
    waveform=x_pulse,   # 脉冲波形
    qubit_freq=5.0e9    # 脉冲频率（同驾驶频率）
)

print("""
# 第 1 步：创建脉冲程序
prog = PulseProgram(num_qubits=1)

# 第 2 步：设置硬件参数
prog.set_device_params(
    qubit_freq=[5.0e9],
    anharmonicity=[-330e6],
    T1=[80e-6],
    T2=[120e-6]
)

# 第 3 步：定义脉冲波形
x_pulse = waveforms.Gaussian(
    amp=0.8,          # 振幅（单位：无量纲，通常 0-1）
    duration=160,     # 脉冲时长（纳秒）
    sigma=40          # 高斯宽度
)

# 第 4 步：添加脉冲到程序
prog.add_pulse(qubit=0, waveform=x_pulse, qubit_freq=5.0e9)

# 第 5 步：执行模拟
state = prog.state(backend="numpy")
""")

# 执行模拟
print("\n⚙️ 执行模拟...")
state = prog.state(backend="numpy")

print(f"\n✅ 模拟完成！")
print(f"   返回状态向量：{state}")
print(f"   维度：{state.shape}")
print(f"   |0⟩ 概率：{abs(state[0])**2:.4f}")
print(f"   |1⟩ 概率：{abs(state[1])**2:.4f}")

# ========================================================================
# 部分 1.5: 关键指标定义
# ========================================================================

print("""
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
1.5 调教中的关键性能指标（KPI）
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
""")

print("""
📊 单比特门的关键指标

1️⃣ 保真度 (Fidelity)
   ──────────────────
   定义：门的实际效果与理想效果的相似程度
   
   数学：F = ⟨ψ_ideal | ρ_actual | ψ_ideal⟩
   
   范围：0 到 1（1 表示完美）
   
   目标：
     • 初期调教：F > 0.95（95%）
     • 优化后：F > 0.999（99.9% - 接近极限）
   
   来源：
     • 脉冲参数不准确
     • 杂波（leakage）到 |2⟩
     • 驰豫（T1 损失）
     • 相位噪声（T2* 损失）

2️⃣ 泄漏率 (Leakage)
   ────────────
   定义：门执行后落到 |2⟩ 态的概率
   
   公式：L = P_2 = |⟨2|ψ⟩|²
   
   范围：0 到 1
   
   目标：
     • 可接受：< 1%（L < 0.01）
     • 优秀：< 0.1%（L < 0.001）
   
   来源：
     • DRAG 参数 β 选择不当
     • 脉冲包络边缘的尖锐跳变
     • 驾驶频率偏差

3️⃣ Rabi 频率准确度
   ───────────────
   定义：实际旋转角与目标旋转角的偏差
   
   目标：
     • 要求 θ_actual ≈ θ_target
     • 误差 < 1%（Δθ/θ < 0.01）
   
   来源：
     • 脉冲振幅校准偏差
     • 非线性效应

4️⃣ 相干时间表征 (Coherence)
   ──────────────────────
   • T1：能量驰豫时间
     - 测量方法：准备 |1⟩，延迟可变时间，测量衰减
     - 目标：> 100 μs
   
   • T2*：相位驰豫时间（有效）
     - 测量方法：Ramsey 干涉
     - 目标：> 50 μs
   
   • T2：真实相位驰豫时间（Hahn echo）
     - 通常 T2 ≈ 2 × T2*

5️⃣ 门执行时间 (Gate Time)
   ─────────────────
   定义：门完成从开始到结束的时间
   
   约束：
     • 必须 < T1 / 10（防止驰豫干扰）
     • 通常 < 200 ns（单比特）
     • 通常 < 500 ns（双比特）
   
   优化：
     • 更快的门 → 更高的保真度（更少噪声影响）
     • 但过快会增加泄漏（尖锐包络）
""")

# ========================================================================
# 总结与下一步
# ========================================================================

print("""
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
📌 核心要点总结
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

✅ 你已经学会了：
   1. 超导量子比特的三能级模型
   2. 关键硬件参数的含义（ω_q, α, T1, T2）
   3. Rabi 旋转与脉冲时间的关系
   4. 不同脉冲类型的优缺点
   5. 用 TyxonQ 创建第一个脉冲程序

⚠️ 重要提示：
   • 这些参数（ω_q, α, T1, T2）必须通过实验表征获得
   • 不同的硬件设备这些值差异很大
   • 调教的所有工作都围绕优化这些参数进行

🎯 下一步：
   → 进入 step_2_single_qubit_design.py
   → 学习如何通过扫描参数调教单比特门
   → 第一个实际的调教任务：优化 X 门保真度

🔗 关键文件路径：
   • 硬件参数：通常来自 device().get_properties()
   • 脉冲定义：tyxonq.waveforms 模块
   • 执行引擎：prog.state() 或 prog.device().run()

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
""")

print("\n✨ 第 1 步完成！准备进入第 2 步...")
