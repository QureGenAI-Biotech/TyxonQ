# 脉冲校准教程

<cite>
**本文档引用的文件**  
- [pulse_calibration_workflow.rst](file://docs/source/tutorials/advanced/pulse_calibration_workflow.rst)
- [step_1_hardware_basics.py](file://examples/pulse_calibration_tutorial/step_1_hardware_basics.py)
- [step_2_single_qubit_coarse_tuning.py](file://examples/pulse_calibration_tutorial/step_2_single_qubit_coarse_tuning.py)
- [step_3_single_qubit_fine_tuning.py](file://examples/pulse_calibration_tutorial/step_3_single_qubit_fine_tuning.py)
- [pulse_gate_calibration.py](file://examples/pulse_gate_calibration.py)
- [noise_t1_t2_calibration.py](file://examples/noise_t1_t2_calibration.py)
- [waveforms.py](file://src/tyxonq/waveforms.py)
- [defcal_library.py](file://src/tyxonq/compiler/pulse_compile_engine/defcal_library.py)
- [defcal_plan.txt](file://defcal_plan.txt)
- [PULSE_CALIBRATION_AUDIT_SUMMARY.md](file://PULSE_CALIBRATION_AUDIT_SUMMARY.md)
</cite>

## 目录
1. [引言](#引言)
2. [脉冲校准工作流程](#脉冲校准工作流程)
3. [硬件基础与环境设置](#硬件基础与环境设置)
4. [单比特门粗调](#单比特门粗调)
5. [单比特门精细调优](#单比特门精细调优)
6. [脉冲类型与波形](#脉冲类型与波形)
7. [双比特门调校](#双比特门调校)
8. [噪声与退相干校准](#噪声与退相干校准)
9. [系统集成与Defcal库](#系统集成与defcal库)
10. [高级优化与性能对比](#高级优化与性能对比)
11. [关键收获与下一步](#关键收获与下一步)

## 引言

脉冲校准是实现高保真度量子操作的关键步骤。本教程将引导您完成从理论到实践的完整脉冲校准工作流程，帮助您系统性地调优硬件参数，实现高质量的量子门操作。

**脉冲校准的重要性**
─────────────────────────────────────────────────────────────────────────

大多数量子程序员使用高级门API而不考虑物理实现。然而，**一个设计完美的量子算法若没有适当的硬件校准也无法正常工作**。

关键统计数据：
- **无Defcal时**：贝尔态保真度约82% ❌（不适合实际算法）
- **有Defcal时**：贝尔态保真度>95% ✅（适合实际算法）
- **差距**：13%的保真度差异 = 量子计算机能否工作的区别

**您将学习的内容**
─────────────────────────────────────────────────────────────────────────

1. **硬件基础** - 理解量子比特参数、能级和退相干
2. **单比特门校准** - 系统性调优π和π/2旋转至>99%保真度
3. **双比特门设计** - 使用拉比振荡实现基于CR的CNOT门
4. **系统验证** - 验证贝尔态和多比特纠缠
5. **集成与优化** - 构建完整的校准库
6. **Defcal与部署** - 理解校准如何集成到编译流程中

**教程结构**
─────────────────────────────────────────────────────────────────────────

本教程包含7个渐进式步骤，您可以独立运行每个步骤：

```bash
cd examples/pulse_calibration_tutorial
python step_1_hardware_basics.py           # ~30分钟
python step_2_single_qubit_coarse_tuning.py # ~45分钟
python step_3_single_qubit_fine_tuning.py  # ~60分钟
python step_4_two_qubit_gate_tuning.py     # ~75分钟
python step_5_two_qubit_characterization.py # ~60分钟
python step_6_system_integration.py        # ~75分钟
python step_7_advanced_optimization.py     # ~90分钟
```

**Section sources**
- [pulse_calibration_workflow.rst](file://docs/source/tutorials/advanced/pulse_calibration_workflow.rst#L1-L100)

## 脉冲校准工作流程

本教程采用系统性的七步工作流程，从硬件基础到高级优化，逐步提升量子门的保真度。

**七步学习流程**
─────────────────────────────────────────────────────────────────────────

| 步骤 | 主题 | 时间 |
|------|------|------|
| 1 | 硬件基础 | 30分钟 |
| 2 | 单比特门粗调 | 45分钟 |
| 3 | 单比特门精细调优 | 60分钟 |
| 4 | 两比特门设计 | 75分钟 |
| 5 | 贝尔态表征 | 60分钟 |
| 6 | 系统集成 | 75分钟 |
| 7 | Defcal与优化 | 90分钟 |
| **总计** | **完整校准工作流程** | **7-8小时** |

**Section sources**
- [pulse_calibration_workflow.rst](file://docs/source/tutorials/advanced/pulse_calibration_workflow.rst#L700-L750)

## 硬件基础与环境设置

**学习目标**
─────────────────────────────────────────────────────────────────────────

- 理解超导量子比特的三能级模型
- 识别关键硬件参数
- 设置TyxonQ脉冲编程框架

**三能级模型**
─────────────────────────────────────────────────────────────────────────

超导量子比特具有多个能级：

```
    |2⟩ ────────────── E₂ (泄漏态)
         ↑ ↓
        能隙 = α (非谐性)
         ↑ ↓
    |1⟩ ────────────── E₁ (第一激发态)
         ↑ ↓
        能隙 = ω_q (量子比特频率)
         ↑ ↓
    |0⟩ ────────────── E₀ (基态)
```

**核心硬件参数**
─────────────────────────────────────────────────────────────────────────

| 参数 | 典型值 | 物理意义 |
|------|--------|----------|
| `qubit_freq` | 5-6 GHz | 驱动频率（门中心频率） |
| `anharmonicity` | -300至-400 MHz | |1⟩和|2⟩之间的能隙（通常为负） |
| `T1` | 50-150 μs | 能量弛豫时间（|1⟩ → |0⟩） |
| `T2` | 50-200 μs | 相干时间（退相位） |

**运行第1步**
─────────────────────────────────────────────────────────────────────────

```python
from tyxonq import Circuit, waveforms
from tyxonq.core.ir.pulse import PulseProgram

# 定义硬件参数
hardware_config = {
    "qubit_freq": [5.0e9, 5.1e9, 5.2e9],
    "anharmonicity": [-330e6, -320e6, -340e6],
    "T1": [80e-6, 85e-6, 75e-6],
    "T2": [120e-6, 125e-6, 110e-6],
}

# 创建您的第一个脉冲程序
prog = PulseProgram(num_qubits=3)
x_pulse = waveforms.Gaussian(amp=0.8, duration=160, sigma=40)
prog.drag(0, amp=x_pulse.amp, duration=x_pulse.duration, sigma=40, beta=0.2)
```

**预期输出**
─────────────────────────────────────────────────────────────────────────

- 硬件参数表
- 拉比频率分析（典型5-50 MHz）
- 脉冲类型比较
- 三能级系统的可视化表示

**Section sources**
- [pulse_calibration_workflow.rst](file://docs/source/tutorials/advanced/pulse_calibration_workflow.rst#L150-L250)
- [step_1_hardware_basics.py](file://examples/pulse_calibration_tutorial/step_1_hardware_basics.py#L76-L111)

## 单比特门粗调

**学习目标**
─────────────────────────────────────────────────────────────────────────

- 执行参数扫描以找到初始最优值
- 理解拉比振荡频率
- 优化DRAG参数β

**拉比振荡**
─────────────────────────────────────────────────────────────────────────

当您对量子比特施加共振微波脉冲时：

$$
P_1(t) = \sin^2\left(\frac{\gamma V \cdot t}{2}\right)
$$

其中：
- **γ** ≈ 50 MHz/V（耦合常数）
- **V** = 脉冲幅度（0-1 V）
- **t** = 脉冲持续时间（10-200 ns）

关键见解：π脉冲（完全旋转）发生在：

$$
\gamma V \cdot t = \pi
$$

**粗调策略**
─────────────────────────────────────────────────────────────────────────

1. **幅度扫描**：将幅度从0.5到1.0 V变化
2. **寻找π脉冲**：寻找使|1⟩布居数≈1.0的幅度
3. **测量拉比频率**：提取振荡频率
4. **优化DRAG β**：在X轴泄漏和Y轴泄漏之间平衡

**典型结果**
─────────────────────────────────────────────────────────────────────────

粗调后：
- X门：~97-98%保真度
- 估计的拉比频率：3-5 MHz
- 推荐幅度：0.7-0.9 V
- DRAG参数β：0.1-0.3

**Section sources**
- [pulse_calibration_workflow.rst](file://docs/source/tutorials/advanced/pulse_calibration_workflow.rst#L350-L400)
- [step_2_single_qubit_coarse_tuning.py](file://examples/pulse_calibration_tutorial/step_2_single_qubit_coarse_tuning.py#L0-L355)

## 单比特门精细调优

**学习目标**
─────────────────────────────────────────────────────────────────────────

- 实现>99%的单比特门保真度
- 测量和优化拉比振荡
- 设计哈达玛门

**精细调优方法**
─────────────────────────────────────────────────────────────────────────

在第2步的基础上，我们现在关注精度：

1. **精细幅度调整**：在粗调值周围±0.05 V
2. **拉比振荡测量**：
   - 将脉冲持续时间从10到200 ns变化
   - 提取布居数振荡
   - 精确识别π和π/2持续时间

3. **哈达玛门设计**：
   - 持续时间：0.7×（π脉冲持续时间）
   - 幅度：0.78-0.79 V
   - 持续时间：110-115 ns
   - 目标保真度：>98%

**预期结果**
─────────────────────────────────────────────────────────────────────────

- X门：99.3%保真度 ✅
- H门：98.0%保真度 ✅
- 提取的拉比频率：3.12 MHz
- 布居数振荡可见度：>99%

**关键成就**
─────────────────────────────────────────────────────────────────────────

在此步骤之后，您拥有**硬件优化的单比特门**，可以存储在Defcal库中。

**Section sources**
- [pulse_calibration_workflow.rst](file://docs/source/tutorials/advanced/pulse_calibration_workflow.rst#L400-L450)
- [step_3_single_qubit_fine_tuning.py](file://examples/pulse_calibration_tutorial/step_3_single_qubit_fine_tuning.py#L0-L305)

## 脉冲类型与波形

**四种常见脉冲包络形状**
─────────────────────────────────────────────────────────────────────────

1. **常量（方波）**：
   - 简单：A(t) = A₀
   - 缺点：高频旁瓣，向|2⟩泄漏

2. **高斯**：
   - 平滑包络：A(t) = A₀ exp(-t²/(2σ²))
   - 更好的频谱特性
   - 缺点：需要幅度补偿

3. **DRAG（绝热门导数去除）**：
   - I(t) = A₀ exp(-t²/(2σ²))
   - Q(t) = β · dA/dt
   - **关键优势**：显著减少向|2⟩的泄漏
   - 权衡：需要优化额外的β参数

4. **厄米特**：
   - 具有优化频谱特性的高级平滑脉冲

**脉冲类型对比表**
─────────────────────────────────────────────────────────────────────────

| 类型 | 定义 | 泄漏 | 速度 | 复杂度 | 应用 |
|------|------|------|------|--------|------|
| 常量 | A(t) = A₀ (矩形) | 高 (5-10%) | 快 | 简单 | 初期快速测试 |
| 高斯 | A(t) = A₀ exp(-t²/2σ²) | 中 (1-3%) | 中等 | 中等 | 标准生产使用 |
| DRAG | I(t) = A₀ exp(-t²/2σ²) + Q(t) = β·dA/dt | 低 (<1%) | 中等 | 复杂（需要β优化） | 高保真生产 |

**选择建议**
─────────────────────────────────────────────────────────────────────────

- **阶段1（初探）**：使用常量，快速验证概念
- **阶段2（优化）**：切换到高斯，平衡速度和保真度
- **阶段3（生产）**：使用DRAG，最大化保真度

**Section sources**
- [step_1_hardware_basics.py](file://examples/pulse_calibration_tutorial/step_1_hardware_basics.py#L281-L317)
- [waveforms.py](file://src/tyxonq/waveforms.py#L0-L156)

## 双比特门调校

**学习目标**
─────────────────────────────────────────────────────────────────────────

- 设计基于交叉共振（CR）的CNOT门
- 执行系统参数优化
- 实现>95%的双比特门保真度

**双比特门架构**
─────────────────────────────────────────────────────────────────────────

交叉共振（CR）门序列
~~~~~~~~~~~~~~~~~~

CNOT(0→1)门使用CR脉冲：

```
    q0: ─── RX(-π/2) ─── [CR脉冲] ─── RX(π/2) ───
    q1: ─── ─────────── [q1频率的CR] ─────────── 
```

其中：
1. **预旋转**：控制量子比特上的RX(-π/2)
2. **CR驱动**：控制量子比特上目标频率的高斯脉冲
3. **后旋转**：控制量子比特上的RX(π/2)

总持续时间：~280 ns

**参数优化**
─────────────────────────────────────────────────────────────────────────

需要调优的关键参数：

- CR幅度：0.35-0.45 V
- CR持续时间：250-300 ns
- CR驱动频率：目标量子比特频率（例如q1的5.1 GHz）

优化方法：

1. **幅度扫描**：找到使贝尔态保真度≈1.0的幅度
2. **持续时间扫描**：在最佳幅度周围微调
3. **用贝尔态验证**：生成|Φ⁺⟩、|Φ⁻⟩、|Ψ⁺⟩、|Ψ⁻⟩

**预期结果**
─────────────────────────────────────────────────────────────────────────

- CR最佳幅度：0.40 V
- CR最佳持续时间：280 ns
- 贝尔态保真度：>99% ✅
- CNOT保真度：>95% ✅

**Section sources**
- [pulse_calibration_workflow.rst](file://docs/source/tutorials/advanced/pulse_calibration_workflow.rst#L450-L500)
- [pulse_gate_calibration.py](file://examples/pulse_gate_calibration.py#L0-L400)

## 噪声与退相干校准

**物理背景**
─────────────────────────────────────────────────────────────────────────

- **T1（幅度阻尼时间）**：表征能量弛豫|1⟩ → |0⟩
  也称为能量弛豫时间或纵向弛豫时间。
  物理上：γ = 1/T1（阻尼率）

- **T2（相位阻尼时间）**：表征量子相干性的损失
  也称为退相位时间或横向弛豫时间。
  物理上：λ = 1/T2（退相率）
  约束：T2 ≤ 2T1（理论上限）

**校准方法**
─────────────────────────────────────────────────────────────────────────

1. **T1测量（幅度阻尼）**：
   - 准备激发态|1⟩使用X门
   - 应用不同γ的幅度阻尼噪声
   - 测量|1⟩态的布居数
   - 拟合：P₁(γ) = A·exp(-γ·T1) + C → 提取T1 = 1/γ

2. **T2测量（相位阻尼）**：
   - 准备叠加态|+⟩ = (|0⟩ + |1⟩)/√2使用H门
   - 应用不同λ的相位阻尼噪声
   - 应用第二个H门（类似拉姆齐序列）
   - 测量相干衰减
   - 拟合：P(λ) = A·exp(-λ·T2) + C → 提取T2 = 1/λ

**综合校准工作流程**
─────────────────────────────────────────────────────────────────────────

```python
def comprehensive_calibration_workflow():
    """运行完整的T1/T2校准工作流程。"""
    print("\n" + "#"*70)
    print("# 综合噪声校准工作流程")
    print("#"*70)
    
    # 步骤1：T1校准
    T1_calibrated = demonstrate_t1_calibration()
    
    # 步骤2：T2校准
    T2_calibrated = demonstrate_t2_calibration()
    
    # 步骤3：关系分析
    demonstrate_noise_models_relationship()
    
    # 总结
    print("\n" + "="*70)
    print("校准总结")
    print("="*70)
    print(f"  校准的T1: {T1_calibrated:.4f}")
    print(f"  校准的T2: {T2_calibrated:.4f}")
    print(f"  T2/T1比率: {T2_calibrated/T1_calibrated:.4f}")
    print(f"\n  ✓ 校准完成")
    print("="*70)
```

**关键概念**
─────────────────────────────────────────────────────────────────────────

- T1：能量弛豫时间（幅度阻尼γ）
- T2：相干时间（相位阻尼λ）
- 校准：拟合P(γ)或P(λ)以提取弛豫时间
- 用途：噪声表征，误差缓解调优

**Section sources**
- [noise_t1_t2_calibration.py](file://examples/noise_t1_t2_calibration.py#L0-L426)

## 系统集成与Defcal库

**Defcal库系统**
─────────────────────────────────────────────────────────────────────────

Defcal（定义校准）= 用户定义的门校准方案

物理背景：
```
真实量子硬件中，不同量子比特的同一门操作可能需要不同的脉冲参数

例如：X门在不同量子比特上的最优脉冲可能不同
  • q0: DRAG(amp=0.8, duration=40ns, sigma=10, beta=0.2)
  • q1: DRAG(amp=0.85, duration=42ns, sigma=11, beta=0.18)
  • q2: DRAG(amp=0.75, duration=39ns, sigma=9, beta=0.22)

Defcal库的作用：存储和管理这些硬件特定的校准参数
```

**校准库结构**
─────────────────────────────────────────────────────────────────────────

```python
calibration_library = {
    'single_qubit_gates': {
        'X': {
            'amplitude': 0.78,
            'duration_ns': 160,
            'fidelity': 0.9932,
            'pulse_type': 'DRAG',
            'sigma': 40,
            'beta': 0.2
        },
        'H': {
            'amplitude': 0.78,
            'duration_ns': 113,
            'fidelity': 0.9800,
            'pulse_type': 'DRAG'
        },
        'RZ': {
            'pulse_type': 'VirtualZ',
            'fidelity': 1.0
        }
    },
    'two_qubit_gates': {
        'CX_01': {
            'amplitude': 0.40,
            'duration_ns': 280,
            'fidelity': 0.9520,
            'pulse_type': 'CR'
        },
        'CX_12': {
            'amplitude': 0.40,
            'duration_ns': 280,
            'fidelity': 0.9480,
            'pulse_type': 'CR'
        }
    }
}
```

**GHZ态制备**
─────────────────────────────────────────────────────────────────────────

制备三量子比特纠缠：|GHZ⟩ = (|000⟩ + |111⟩)/√2

```python
circuit = Circuit(3)
circuit.h(0)
circuit.cx(0, 1)
circuit.cx(1, 2)
circuit.measure_z(0, 1, 2)
```

预期GHZ保真度：>89% ✅

**Section sources**
- [pulse_calibration_workflow.rst](file://docs/source/tutorials/advanced/pulse_calibration_workflow.rst#L550-L600)
- [step_6_system_integration.py](file://examples/pulse_calibration_tutorial/step_6_system_integration.py#L31-L56)
- [defcal_library.py](file://src/tyxonq/compiler/pulse_compile_engine/defcal_library.py#L0-L564)

## 高级优化与性能对比

**什么是Defcal？**
─────────────────────────────────────────────────────────────────────────

Defcal = 校准定义

**核心概念**：Defcal弥合了逻辑门和物理脉冲之间的差距。

**三层架构**
─────────────────────────────────────────────────────────────────────────

```
┌────────────────────────────────────┐
│ 逻辑层（用户代码）                 │
│ circuit.h(0)                       │
│ circuit.cx(0, 1)                   │
└────────────┬───────────────────────┘
             │
             ▼
┌────────────────────────────────────┐
│ Defcal层（校准库）                 │
│ defcal H 0:                        │
│   pulse.play(Gaussian(...))        │
│ defcal CX 0 1:                     │
│   pulse.play(...) × 3              │
└────────────┬───────────────────────┘
             │
             ▼
┌────────────────────────────────────┐
│ 物理层（硬件执行）                 │
│ 生成微波脉冲                       │
│ 测量量子态                         │
└────────────────────────────────────┘
```

**带Defcal的编译流程**
─────────────────────────────────────────────────────────────────────────

```
电路（逻辑） 
    │
    ▼
GateToPulsePass
    │
    ├─ 查询Defcal库中的每个门
    │  ├─ H(0) → 找到：Gaussian(amp=0.78, dur=113ns)
    │  ├─ CX(0,1) → 找到：CR序列
    │  └─ MeasureZ → 转换为测量脉冲
    │
    ├─ Virtual-Z优化
    │  └─ 合并连续的RZ门
    │
    ▼
TQASM（中间代码）
    │
    ▼
设备执行
```

**性能对比：有无Defcal**
─────────────────────────────────────────────────────────────────────────

| 指标 | 无Defcal | 有Defcal |
|------|----------|----------|
| H门保真度 | ~93% | 99.3% |
| CX门保真度 | ~88% | 95.2% |
| 贝尔态保真度 | 81.8% | 94.6% |
| 多量子比特电路 | ❌ 不可用 | ✅ 可用 |
| VQE收敛 | 困难 | 快速 |
| QAOA近似比 | 差（α<0.5） | 好（α>0.7） |

关键见解：**13%的保真度差距决定了量子计算是否可行。**

**Virtual-Z优化**
─────────────────────────────────────────────────────────────────────────

与其应用物理Z旋转（耗时且引入误差），我们可以通过在软件中跟踪相位来应用"虚拟"Z旋转：

```python
# 物理表示（朴素）
circuit.rz(π/2, 0)     # 物理脉冲
circuit.rz(π/4, 0)     # 物理脉冲

# Virtual-Z优化（我们的方法）
circuit.rz(3π/4, 0)    # 单次虚拟旋转（无物理脉冲）

# 优势：
# - 2个脉冲 → 1个虚拟操作
# - 电路执行时间减少35%
# - 零额外误差
```

**Section sources**
- [pulse_calibration_workflow.rst](file://docs/source/tutorials/advanced/pulse_calibration_workflow.rst#L600-L700)
- [pulse_gate_calibration.py](file://examples/pulse_gate_calibration.py#L0-L400)

## 关键收获与下一步

**关键收获**
─────────────────────────────────────────────────────────────────────────

1. **硬件参数是基础**
   理解量子比特频率、退相干时间和非谐性对于脉冲设计至关重要。

2. **系统校准有效**
   通过遵循结构化方法（粗调→精调→多量子比特→集成），您可以实现>95%的门保真度。

3. **Defcal是桥梁**
   Defcal库透明地连接高级量子算法与低级硬件实现。

4. **保真度是关键**
   82%和95%保真度之间的差异决定了您的量子算法是否能产生有意义的结果。

5. **TyxonQ使其可行**
   该框架自动化了参数搜索、编译和优化，因此您可以专注于算法设计。

**下一步**
─────────────────────────────────────────────────────────────────────────

完成本教程后：

1. **应用于真实硬件**：
   - 在您自己的量子处理器上使用这些技术
   - 为您的特定硬件特性调整参数

2. **构建自定义门**：
   - 设计为您的算法优化的专用门
   - 创建特定问题的门集

3. **与算法集成**：
   - 在VQE、QAOA和其他变分算法中使用校准门
   - 观察收敛和结果的显著改进

4. **高级主题**：
   - 门设计的最优控制理论
   - 用于误差抑制的复合脉冲
   - 泄漏消除算子（LEO）
   - CPHASE和其他奇异门

**故障排除常见问题**
─────────────────────────────────────────────────────────────────────────

**问题：第2步中保真度低**

解决方案：
- 检查硬件参数是否匹配您的设备
- 尝试不同的脉冲包络（高斯vs DRAG）
- 验证T1/T2值是否现实
- 增加信号平均

**问题：贝尔态保真度在~90%处停滞**

解决方案：
- 执行更精细的幅度/持续时间扫描
- 优化DRAG β参数
- 检查量子比特之间的串扰
- 考虑失谐校正

**问题：Defcal编译错误**

解决方案：
- 确保DefcalLibrary门与电路门名称匹配
- 验证所有量子比特都有校准
- 检查保真度值是否在0和1之间
- 使用正确的量子比特索引

**Section sources**
- [pulse_calibration_workflow.rst](file://docs/source/tutorials/advanced/pulse_calibration_workflow.rst#L750-L850)