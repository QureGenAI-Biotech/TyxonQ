# 化学功能库

<cite>
**本文档引用的文件**   
- [ansatz_uccsd.py](file://src/tyxonq/applications/chem/chem_libs/circuit_chem_library/ansatz_uccsd.py)
- [ansatz_kupccgsd.py](file://src/tyxonq/applications/chem/chem_libs/circuit_chem_library/ansatz_kupccgsd.py)
- [hamiltonian_builders.py](file://src/tyxonq/applications/chem/chem_libs/hamiltonians_chem_library/hamiltonian_builders.py)
- [ci_state_mapping.py](file://src/tyxonq/applications/chem/chem_libs/quantum_chem_library/ci_state_mapping.py)
- [civector_ops.py](file://src/tyxonq/applications/chem/chem_libs/quantum_chem_library/civector_ops.py)
- [statevector_ops.py](file://src/tyxonq/applications/chem/chem_libs/quantum_chem_library/statevector_ops.py)
- [pyrazine.py](file://src/tyxonq/applications/chem/chem_libs/hamiltonians_chem_library/pyrazine.py)
- [sbm.py](file://src/tyxonq/applications/chem/chem_libs/hamiltonians_chem_library/sbm.py)
- [pauli_io.py](file://src/tyxonq/libs/hamiltonian_encoding/pauli_io.py) - *更新了性能缓存机制*
</cite>

## 更新摘要
**主要变更**   
- 修复了`hamiltonian_builders.py`中的重大bug，影响哈密顿量构建的正确性
- 在`pauli_io.py`中引入了缓存机制，优化了哈密顿量转换性能
- 更新了哈密顿量构建流程的文档说明，反映最新的实现细节
- 增加了对`pauli_io.py`文件的引用，以反映其在哈密顿量转换中的关键作用

## 目录
1. [引言](#引言)
2. [预定义Ansatz电路](#预定义ansatz电路)
3. [哈密顿量构建器](#哈密顿量构建器)
4. [量子化学算子库](#量子化学算子库)
5. [模块加载与集成实践](#模块加载与集成实践)
6. [外部工具数据交换接口](#外部工具数据交换接口)

## 引言
本系统化文档旨在全面阐述TyxonQ平台中的化学功能库，涵盖预定义的量子电路模板（Ansatz）、哈密顿量构建工具以及量子化学算子操作库。该功能库为量子化学模拟提供了完整的基础设施，支持从分子哈密顿量构建到变分量子算法执行的全流程。核心组件包括UCCSD、kUpCCGSD等先进的变分电路模板，支持多种电子结构哈密顿量的生成与群分解，以及在CI向量空间和态向量空间中的高效算子操作。本库的设计遵循模块化原则，便于与主算法集成，并通过标准化接口与外部工具如OpenFermion进行数据交换，为量子化学计算提供了一个强大且灵活的开发环境。

## 预定义Ansatz电路
本节详细说明化学功能库中提供的预定义Ansatz电路模板，包括`ansatz_uccsd`和`ansatz_kupccgsd`，重点阐述其电路结构特点与可调参数的生成机制。

### ansatz_uccsd 电路模板
`ansatz_uccsd`模块实现了标准的UCCSD（Unitary Coupled Cluster Singles and Doubles）变分量子电路模板。该模板通过生成单激发和双激发算子来构建量子电路，其结构特点如下：
- **单激发算子生成**：函数`generate_uccsd_ex1_ops`根据占据轨道数（no）和虚拟轨道数（nv）生成所有可能的单电子激发算子。每个激发算子对应一个泡利串，函数同时生成参数ID列表和初始猜测值，确保与传统实现的兼容性。
- **双激发算子生成**：函数`generate_uccsd_ex2_ops`生成所有可能的双电子激发算子，包括同自旋（AA/BB）和异自旋（AB）激发。该函数支持从空间轨道振幅（t2）或自旋轨道振幅（t2_spin）初始化参数，确保了与经典量子化学计算结果的衔接。
- **参数化**：电路的可调参数与激发算子一一对应，参数ID列表用于在优化过程中正确映射梯度。初始猜测值通常来自经典耦合簇计算的振幅。

**Section sources**
- [ansatz_uccsd.py](file://src/tyxonq/applications/chem/chem_libs/circuit_chem_library/ansatz_uccsd.py#L1-L132)

### ansatz_kupccgsd 电路模板
`ansatz_kupccgsd`模块实现了kUpCCGSD（k-Universal Pairing UpCCGSD）电路模板，这是一种更通用的变分形式，其结构特点如下：
- **广义单激发**：函数`generate_kupccgsd_ex1_ops`生成所有可能的单电子激发，其激发算子覆盖了从任意低能级到任意高能级的跃迁，比UCCSD更具普遍性。
- **配对双激发**：函数`generate_kupccgsd_ex2_ops`生成配对的双电子激发算子，这些算子作用于同一对轨道上，体现了配对相关效应。
- **k层结构**：函数`generate_kupccgsd_ex_ops`将单激发和双激发算子序列重复k次，形成k层的深度电路，增强了表达能力。
- **参数化**：与UCCSD类似，生成参数ID和初始猜测值（此处为随机初始化），参数ID列表确保了多层结构中参数的唯一性。

**Section sources**
- [ansatz_kupccgsd.py](file://src/tyxonq/applications/chem/chem_libs/circuit_chem_library/ansatz_kupccgsd.py#L1-L59)

## 哈密顿量构建器
本节介绍`hamiltonians_chem_library`中支持的哈密顿量类型及其构建策略，重点说明电子哈密顿量和自旋玻色子模型的实现。

### 电子哈密顿量构建
`hamiltonian_builders.py`模块提供了从Hartree-Fock（HF）计算结果构建电子哈密顿量的完整流程，该流程已修复重大bug并优化了性能：
- **积分提取**：`get_integral_from_hf`函数从PySCF的RHF对象中提取活性空间的一电子和二电子积分。该函数现在确保分子轨道系数经过规范化处理，提高了数值稳定性。
- **费米子哈密顿量**：`get_hop_from_integral`函数将分子积分转换为费米子算符形式的哈密顿量，这是量子化学计算的标准输入。
- **稀疏矩阵表示**：`get_h_sparse_from_integral`函数将费米子哈密顿量转换为稀疏矩阵（COO格式），适用于小规模系统的精确对角化。该函数通过`fop_to_coo`工具函数实现，现在支持数值后端的稀疏矩阵构建，提升了性能。
- **MPO表示**：`get_h_mpo_from_integral`函数将哈密顿量包装为MPO（Matrix Product Operator）对象，用于与张量网络方法的集成。
- **CI空间作用函数**：`get_h_fcifunc_from_integral`函数返回一个可调用对象，该对象能高效地在CI（Configuration Interaction）基底下计算哈密顿量对态向量的作用，这是迭代求解基态能量的核心。

**Section sources**
- [hamiltonian_builders.py](file://src/tyxonq/applications/chem/chem_libs/hamiltonians_chem_library/hamiltonian_builders.py#L1-L298) - *修复了重大bug，更新了实现细节*
- [pauli_io.py](file://src/tyxonq/libs/hamiltonian_encoding/pauli_io.py#L61-L65) - *引入了缓存机制，优化了性能*

### 自旋玻色子模型哈密顿量
该库还支持构建特定的物理模型哈密顿量，如吡嗪（Pyrazine）和自旋-玻色子模型（SBM）：
- **吡嗪模型**：`pyrazine.py`模块实现了吡嗪分子的双线性振动-电子耦合模型。`get_ham_terms`函数根据预设的物理参数（频率、耦合系数）生成哈密顿量的各项，包括电子项、振动动能与势能项以及电子-振动耦合项。
- **自旋-玻色子模型**：`sbm.py`模块实现了标准的自旋-玻色子模型。`get_ham_terms`函数生成自旋项（σz, σx）和多个玻色子模式的哈密顿量项，以及自旋与玻色子之间的线性耦合项。
- **基底定义**：两个模块都提供了`get_basis`函数，用于定义每个自由度的基底（如电子态、谐振子能级），这是构建全系统哈密顿量矩阵的前提。

**Section sources**
- [pyrazine.py](file://src/tyxonq/applications/chem/chem_libs/hamiltonians_chem_library/pyrazine.py#L1-L138)
- [sbm.py](file://src/tyxonq/applications/chem/chem_libs/hamiltonians_chem_library/sbm.py#L1-L25)

## 量子化学算子库
本节阐述`quantum_chem_library`如何实现CI向量操作、态映射和算符张量处理，这是高效执行量子化学算法的核心。

### CI向量操作与态映射
`ci_state_mapping.py`和`civector_ops.py`模块共同构成了CI空间操作的基础：
- **CI基底生成**：`get_ci_strings`函数根据量子比特数、电子数和模式（费米子/硬核玻色子）生成所有可能的Slater行列式对应的位串，并提供从位串到数组索引的映射（`get_addr`）。
- **态向量转换**：`civector_to_statevector`和`statevector_to_civector`函数实现了CI向量与全希尔伯特空间态向量之间的双向转换。
- **初态准备**：`get_init_civector`函数生成对应于Hartree-Fock基态的CI向量（第一个元素为1，其余为0）。
- **激发算子应用**：`apply_excitation_civector`函数利用预计算的置换和相位张量，高效地将单个激发算子作用于CI向量上。

**Section sources**
- [ci_state_mapping.py](file://src/tyxonq/applications/chem/chem_libs/quantum_chem_library/ci_state_mapping.py#L1-L167)
- [civector_ops.py](file://src/tyxonq/applications/chem/chem_libs/quantum_chem_library/civector_ops.py#L1-L240)

### 算符张量处理
`ci_operator_tensors.py`模块通过预计算张量来优化UCC电路的演化过程：
- **算符张量生成**：`get_operator_tensors`函数一次性计算所有激发算子所需的置换张量（`fket_permutation_tensor`）、相位张量（`fket_phase_tensor`）和二次相位张量（`f2ket_phase_tensor`）。这些张量将复杂的费米子符号问题转化为高效的数组索引和乘法操作。
- **CI向量演化**：`evolve_civector_by_tensor`函数利用上述张量，通过简单的数组操作（索引、乘法、加法）来执行UCC电路对CI向量的演化，避免了显式构造和存储巨大的哈密顿量矩阵，极大地提高了计算效率。
- **参数处理**：`get_theta_tensors`函数将电路参数转换为正弦和(1-cos)值，直接用于演化公式，优化了计算流程。

**Section sources**
- [ci_operator_tensors.py](file://src/tyxonq/applications/chem/chem_libs/quantum_chem_library/ci_operator_tensors.py#L1-L176)

### 态向量空间操作
`statevector_ops.py`模块提供了在全态向量空间中的操作，用于与基于态向量的模拟器对接：
- **激发算子应用**：`apply_excitation_statevector`函数首先在CI空间内应用激发算子，然后将结果嵌入到全希尔伯特空间的态向量中。
- **态向量构建**：`get_statevector_from_params`函数利用CI向量构建方法，生成完整的量子态向量。
- **能量与梯度计算**：`energy_statevector`和`energy_and_grad_statevector`函数利用OpenFermion的稀疏算符功能，直接在态向量上计算哈密顿量的期望值及其梯度，为基于自动微分的优化提供了支持。

**Section sources**
- [statevector_ops.py](file://src/tyxonq/applications/chem/chem_libs/quantum_chem_library/statevector_ops.py#L1-L104)

## 模块加载与集成实践
本节提供从化学库加载预设模块并与主算法集成的实践指南。

### 加载预设模块
用户可以通过标准的Python导入机制加载化学库中的各个模块：
- **Ansatz电路**：`from tyxonq.applications.chem.chem_libs.circuit_chem_library import ansatz_uccsd, ansatz_kupccgsd`
- **哈密顿量构建器**：`from tyxonq.applications.chem.chem_libs.hamiltonians_chem_library import hamiltonian_builders`
- **量子化学算子**：`from tyxonq.applications.chem.chem_libs.quantum_chem_library import ci_state_mapping, civector_ops`

### 与主算法集成
一个典型的集成流程如下：
1.  **构建哈密顿量**：使用`hamiltonian_builders.get_h_from_hf`从PySCF的HF对象构建哈密顿量（稀疏矩阵或MPO）。
2.  **生成Ansatz**：根据分子信息，调用`ansatz_uccsd.generate_uccsd_ex1_ops`和`ansatz_uccsd.generate_uccsd_ex2_ops`生成激发算子列表和参数ID。
3.  **执行算法**：将生成的激发算子和参数ID传递给主算法（如VQE求解器）。主算法使用`civector_ops.civector`或`statevector_ops.get_statevector_from_params`来计算当前参数下的量子态，并使用`civector_ops.energy_and_grad_civector`或`statevector_ops.energy_and_grad_statevector`来计算能量和梯度以进行优化。

**Section sources**
- [ansatz_uccsd.py](file://src/tyxonq/applications/chem/chem_libs/circuit_chem_library/ansatz_uccsd.py#L1-L132)
- [hamiltonian_builders.py](file://src/tyxonq/applications/chem/chem_libs/hamiltonians_chem_library/hamiltonian_builders.py#L1-L298)
- [civector_ops.py](file://src/tyxonq/applications/chem/chem_libs/quantum_chem_library/civector_ops.py#L1-L240)

## 外部工具数据交换接口
本节说明化学库如何与外部工具（如OpenFermion）进行数据交换。

### OpenFermion接口
化学库通过OpenFermion库实现了与外部工具的数据交换：
- **数据输入**：`hamiltonian_builders.py`中的`get_hop_from_integral`函数直接使用`openfermion.FermionOperator`来构建费米子哈密顿量，确保了与OpenFermion生态的兼容性。
- **数据输出**：`get_h_fcifunc_from_integral`等函数的输出可以无缝地与OpenFermion的`get_sparse_operator`等函数对接，用于验证或进一步分析。
- **算符转换**：`ci_operator_tensors.py`和`statevector_ops.py`中使用`jordan_wigner`变换将费米子算符转换为泡利算符，这是将化学问题映射到量子计算机的标准方法。

**Section sources**
- [hamiltonian_builders.py](file://src/tyxonq/applications/chem/chem_libs/hamiltonians_chem_library/hamiltonian_builders.py#L1-L298)
- [ci_operator_tensors.py](file://src/tyxonq/applications/chem/chem_libs/quantum_chem_library/ci_operator_tensors.py#L1-L176)
- [statevector_ops.py](file://src/tyxonq/applications/chem/chem_libs/quantum_chem_library/statevector_ops.py#L1-L104)